<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="knowledge_onthisday_oca.KnowledgeDocumentView" owl="1">
        <div class="o_knowledge_document_view">
            <!-- Left Sidebar -->
            <div class="o_knowledge_sidebar">
                <!-- Search Bar -->
                <div class="o_knowledge_search">
                    <input
                        type="text"
                        class="o_knowledge_search_input"
                        placeholder="Search an article..."
                        t-on-input="(ev) => this.onSearchChange(ev.target.value)"
                    />
                    <!-- Active Tag Filter -->
                    <t t-if="state.selectedTagId">
                        <div class="o_knowledge_tag_filter">
                            <t t-set="selectedTag" t-value="state.availableTags.find(t => t.id === state.selectedTagId)"/>
                            <t t-if="selectedTag">
                                <span class="o_knowledge_tag_filter_label">Filtered by:</span>
                                <span class="o_knowledge_tag o_knowledge_tag_active"
                                      t-att-style="selectedTag.color !== false and selectedTag.color !== null and selectedTag.color !== undefined ? `background-color: var(--tag-color-${selectedTag.color}, var(--knowledge-primary)); color: var(--knowledge-text-on-primary); border-color: var(--tag-color-${selectedTag.color}, var(--knowledge-primary));` : ''"
                                      t-att-data-color-index="selectedTag.color">
                                    <span t-esc="selectedTag.name"/>
                                    <span class="o_knowledge_tag_close" t-on-click.stop="() => this.clearTagFilter()" title="Clear filter">√ó</span>
                                </span>
                            </t>
                        </div>
                    </t>
                </div>
                
                <!-- Tags Section -->
                <t t-if="state.availableTags and state.availableTags.length > 0">
                    <div class="o_knowledge_tags_section">
                        <div class="o_knowledge_tags_header">
                            <span class="o_knowledge_tags_title">Tags</span>
                            <t t-if="state.selectedTagId">
                                <button class="o_knowledge_tags_clear" t-on-click="() => this.clearTagFilter()" title="Clear tag filter">
                                    Clear
                                </button>
                            </t>
                        </div>
                        <div class="o_knowledge_tags_list">
                            <t t-foreach="state.availableTags" t-as="tag" t-key="tag.id">
                                <span class="o_knowledge_tag o_knowledge_tag_clickable"
                                      t-att-class="{'o_knowledge_tag_active': state.selectedTagId === tag.id}"
                                      t-on-click="() => this.onTagClick(tag.id)"
                                      t-att-style="tag.color !== false and tag.color !== null and tag.color !== undefined ? `background-color: var(--tag-color-${tag.color}-light, var(--knowledge-primary-bg-fallback)); color: var(--tag-color-${tag.color}, var(--knowledge-primary)); border-color: var(--tag-color-${tag.color}-border, var(--knowledge-primary-border-fallback));` : ''"
                                      t-att-data-color-index="tag.color"
                                      t-att-title="`Filter articles by ${tag.name}`">
                                    <span t-esc="tag.name"/>
                                </span>
                            </t>
                        </div>
                    </div>
                </t>

                <!-- Sections -->
                <div class="o_knowledge_sections">
                    <!-- Favorites -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('favorites')"
                        >
                            <span class="o_knowledge_section_title">Favorites</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'favorites'">
                            <t t-if="state.articles and state.articles.length > 0">
                                <!-- Display favorite articles as flat list (no category grouping) -->
                                <t t-foreach="state.articles" t-as="article" t-key="article.id">
                                    <div class="o_knowledge_article_item o_knowledge_article_parent"
                                         t-att-class="{'o_active': state.selectedArticleId === article.id, 'o_expanded': this.isExpanded(article.id)}">
                                        <div class="o_knowledge_article_item_header"
                                             t-on-click="(ev) => this.onArticleClick(article.id, ev)">
                                            <t t-if="article.children and article.children.length > 0">
                                                <span class="o_knowledge_expand_icon"
                                                      t-att-class="this.isExpanded(article.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"
                                                      t-on-click.stop="() => this.toggleExpand(article.id)">
                                                </span>
                                            </t>
                                            <t t-else="">
                                                <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                            </t>
                                            <span class="o_knowledge_article_icon" t-esc="article.category_icon || 'üìù'"/>
                                            <div class="o_knowledge_article_info">
                                                <span class="o_knowledge_article_name" t-esc="article.name"/>
                                            </div>
                                        </div>
                                        <t t-if="article.children and article.children.length > 0 and this.isExpanded(article.id)">
                                            <div class="o_knowledge_article_children">
                                                <t t-foreach="article.children" t-as="child" t-key="child.id">
                                                    <div class="o_knowledge_article_item o_knowledge_article_child"
                                                         t-on-click.stop="() => this.onArticleClick(child.id)"
                                                         t-att-class="{'o_active': state.selectedArticleId === child.id}">
                                                        <div class="o_knowledge_article_item_header">
                                                            <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                            <span class="o_knowledge_article_icon" t-esc="child.category_icon || 'üìù'"/>
                                                            <div class="o_knowledge_article_info">
                                                                <span class="o_knowledge_article_name" t-esc="child.name"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="o_knowledge_empty">
                                    <div class="o_knowledge_empty_icon">‚≠ê</div>
                                    <div class="o_knowledge_empty_text">No favorite articles yet</div>
                                    <div class="o_knowledge_empty_subtext">Mark articles as favorites to access them quickly</div>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Workspace -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('workspace')"
                        >
                            <span class="o_knowledge_section_title">Workspace</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'workspace'">
                            <t t-if="!state.loading">
                                <t t-if="state.articles and state.articles.length > 0">
                                    <!-- Show all categories, including those with articles -->
                                    <t t-foreach="state.articles" t-as="category" t-key="category.id">
                                        <!-- Category Header -->
                                        <div class="o_knowledge_category_group">
                                            <div class="o_knowledge_category_header"
                                                 t-att-class="{'o_expanded': this.isCategoryExpanded(category.id)}"
                                                 t-on-click="() => this.toggleExpandCategory(category.id)">
                                                <span class="o_knowledge_expand_icon"
                                                      t-att-class="this.isCategoryExpanded(category.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'">
                                                </span>
                                                <span class="o_knowledge_category_icon" t-esc="category.icon || 'üìù'"/>
                                                <span class="o_knowledge_category_name" t-esc="category.name || 'Uncategorized'"/>
                                                <span class="o_knowledge_category_count" t-esc="`(${category.articles ? category.articles.length : 0})`"/>
                                            </div>
                                            
                                            <!-- Category Articles -->
                                            <t t-if="this.isCategoryExpanded(category.id)">
                                                <div class="o_knowledge_category_articles">
                                                    <!-- Debug: Show category info -->
                                                    <t t-if="category.id === 'uncategorized'">
                                                        <!-- Debug info for Uncategorized -->
                                                    </t>
                                                    <t t-if="category.articles and category.articles.length > 0">
                                                        <t t-foreach="category.articles" t-as="article" t-key="article.id">
                                                            <div class="o_knowledge_article_item o_knowledge_article_parent"
                                                                 t-att-class="{'o_active': state.selectedArticleId === article.id, 'o_expanded': this.isExpanded(article.id)}">
                                                                <div class="o_knowledge_article_item_header"
                                                                     t-on-click="(ev) => this.onArticleClick(article.id, ev)">
                                                                    <t t-if="article.children and article.children.length > 0">
                                                                        <span class="o_knowledge_expand_icon"
                                                                              t-att-class="this.isExpanded(article.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"
                                                                              t-on-click.stop="() => this.toggleExpand(article.id)">
                                                                        </span>
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                    </t>
                                                                    <span class="o_knowledge_article_icon" t-esc="article.category_icon || 'üìù'"/>
                                                                    <div class="o_knowledge_article_info">
                                                                        <span class="o_knowledge_article_name" t-esc="article.name"/>
                                                                    </div>
                                                                </div>
                                                                <t t-if="article.children and article.children.length > 0 and this.isExpanded(article.id)">
                                                                    <div class="o_knowledge_article_children">
                                                                        <t t-foreach="article.children" t-as="child" t-key="child.id">
                                                                            <div class="o_knowledge_article_item o_knowledge_article_child"
                                                                                 t-on-click.stop="() => this.onArticleClick(child.id)"
                                                                                 t-att-class="{'o_active': state.selectedArticleId === child.id}">
                                                                                <div class="o_knowledge_article_item_header">
                                                                                    <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                                    <span class="o_knowledge_article_icon" t-esc="child.category_icon || 'üìù'"/>
                                                                                    <div class="o_knowledge_article_info">
                                                                                        <span class="o_knowledge_article_name" t-esc="child.name"/>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </t>
                                                                    </div>
                                                                </t>
                                                            </div>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="o_knowledge_empty_category">
                                                            <span>No articles in this category yet</span>
                                                        </div>
                                                    </t>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="o_knowledge_empty">
                                        <div class="o_knowledge_empty_icon">üìö</div>
                                        <div class="o_knowledge_empty_text">No articles yet</div>
                                        <div class="o_knowledge_empty_subtext">Create your first article to get started</div>
                                    </div>
                                </t>
                            </t>
                        </div>
                    </div>

                    <!-- Shared -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('shared')"
                        >
                            <span class="o_knowledge_section_title">Shared</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'shared'">
                            <t t-if="state.articles and state.articles.length > 0">
                                <!-- Display shared articles grouped by category -->
                                <t t-foreach="state.articles" t-as="category" t-key="category.id">
                                    <div class="o_knowledge_category_group">
                                        <div class="o_knowledge_category_header"
                                             t-att-class="{'o_expanded': this.isCategoryExpanded(category.id)}"
                                             t-on-click="() => this.toggleExpandCategory(category.id)">
                                            <span class="o_knowledge_expand_icon"
                                                  t-att-class="this.isCategoryExpanded(category.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'">
                                            </span>
                                            <span class="o_knowledge_category_icon" t-esc="category.icon || 'üìù'"/>
                                            <span class="o_knowledge_category_name" t-esc="category.name || 'Uncategorized'"/>
                                            <span class="o_knowledge_category_count" t-esc="`(${category.articles ? category.articles.length : 0})`"/>
                                        </div>
                                        <t t-if="this.isCategoryExpanded(category.id)">
                                            <div class="o_knowledge_category_articles">
                                                <t t-if="category.articles and category.articles.length > 0">
                                                    <t t-foreach="category.articles" t-as="article" t-key="article.id">
                                                        <div class="o_knowledge_article_item o_knowledge_article_parent"
                                                             t-att-class="{'o_active': state.selectedArticleId === article.id, 'o_expanded': this.isExpanded(article.id)}">
                                                            <div class="o_knowledge_article_item_header"
                                                                 t-on-click="(ev) => this.onArticleClick(article.id, ev)">
                                                                <t t-if="article.children and article.children.length > 0">
                                                                    <span class="o_knowledge_expand_icon"
                                                                          t-att-class="this.isExpanded(article.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"
                                                                          t-on-click.stop="() => this.toggleExpand(article.id)">
                                                                    </span>
                                                                </t>
                                                                <t t-else="">
                                                                    <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                </t>
                                                                <span class="o_knowledge_article_icon" t-esc="article.category_icon || 'üìù'"/>
                                                                <div class="o_knowledge_article_info">
                                                                    <span class="o_knowledge_article_name" t-esc="article.name"/>
                                                                </div>
                                                            </div>
                                                            <t t-if="article.children and article.children.length > 0 and this.isExpanded(article.id)">
                                                                <div class="o_knowledge_article_children">
                                                                    <t t-foreach="article.children" t-as="child" t-key="child.id">
                                                                        <div class="o_knowledge_article_item o_knowledge_article_child"
                                                                             t-on-click.stop="() => this.onArticleClick(child.id)"
                                                                             t-att-class="{'o_active': state.selectedArticleId === child.id}">
                                                                            <div class="o_knowledge_article_item_header">
                                                                                <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                                <span class="o_knowledge_article_icon" t-esc="child.category_icon || 'üìù'"/>
                                                                                <div class="o_knowledge_article_info">
                                                                                    <span class="o_knowledge_article_name" t-esc="child.name"/>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </t>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </t>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="o_knowledge_empty">
                                    <div class="o_knowledge_empty_icon">üîó</div>
                                    <div class="o_knowledge_empty_text">No shared articles yet</div>
                                    <div class="o_knowledge_empty_subtext">Articles shared with you will appear here</div>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Private -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('private')"
                        >
                            <span class="o_knowledge_section_title">Private</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'private'">
                            <div class="o_knowledge_empty">No private articles yet</div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Actions -->
                <div class="o_knowledge_bottom_actions">
                    <div class="o_knowledge_action_item">
                        <span class="o_knowledge_action_icon">üìÑ</span>
                        <span class="o_knowledge_action_label">Browse Templates</span>
                    </div>
                    <div class="o_knowledge_action_item">
                        <span class="o_knowledge_action_icon">üóëÔ∏è</span>
                        <span class="o_knowledge_action_label">Open the Trash</span>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="o_knowledge_main_content">
                <t t-if="state.loading">
                    <div class="o_knowledge_loading">Loading article...</div>
                </t>
                <t t-elif="state.currentArticle">
                    <!-- Article Header -->
                    <div class="o_knowledge_article_header">
                        <div class="o_knowledge_article_header_left">
                            <h1 class="o_knowledge_article_title">
                                <span class="o_knowledge_article_icon" t-esc="state.currentArticle.category_icon || 'üìù'"/>
                                <span t-esc="state.currentArticle.name"/>
                            </h1>
                            <!-- Tags -->
                            <t t-if="state.currentArticle.tag_ids and state.currentArticle.tag_ids.length > 0">
                                <div class="o_knowledge_article_tags">
                                    <t t-foreach="state.currentArticle.tag_ids" t-as="tag" t-key="tag.id">
                                        <span class="o_knowledge_tag o_knowledge_tag_clickable" 
                                              t-att-class="{'o_knowledge_tag_active': state.selectedTagId === tag.id}"
                                              t-on-click.stop="() => this.onTagClick(tag.id)"
                                              t-att-style="tag.color !== false and tag.color !== null and tag.color !== undefined ? `background-color: var(--tag-color-${tag.color}-light, var(--knowledge-primary-bg-fallback)); color: var(--tag-color-${tag.color}, var(--knowledge-primary)); border-color: var(--tag-color-${tag.color}-border, var(--knowledge-primary-border-fallback));` : ''"
                                              t-att-data-color-index="tag.color"
                                              t-att-title="`Click to filter by ${tag.name}`">
                                            <span t-esc="tag.name"/>
                                        </span>
                                    </t>
                                </div>
                            </t>
                        </div>
                        <div class="o_knowledge_article_header_right">
                            <button class="btn btn-primary" t-on-click="() => this.onEditArticle()">
                                <span>‚úèÔ∏è</span> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                            </button>
                            <button class="btn btn-secondary" t-on-click="() => this.onCreateArticle()">
                                <span>‚ûï</span> New
                            </button>
                            <button 
                                class="btn btn-link" 
                                t-att-class="{'o_favorited': this.isFavorited(state.currentArticle)}"
                                t-on-click="() => this.toggleFavorite(state.currentArticle.id)"
                                title="Favorite">
                                <span t-if="this.isFavorited(state.currentArticle)">‚≠ê</span>
                                <span t-else="">‚òÜ</span>
                            </button>
                            <button 
                                class="btn btn-link" 
                                t-att-class="{'o_shared': this.isShared(state.currentArticle)}"
                                t-on-click="() => this.toggleShare(state.currentArticle.id)"
                                t-att-title="this.isShared(state.currentArticle) ? `Shared with ${this.getSharedCount(state.currentArticle)} user(s)` : 'Share'">
                                <span t-if="this.isShared(state.currentArticle)">üîó</span>
                                <span t-else="">Share</span>
                                <span t-if="this.isShared(state.currentArticle) and this.getSharedCount(state.currentArticle) > 0" 
                                      class="o_share_count" 
                                      t-esc="`(${this.getSharedCount(state.currentArticle)})`"/>
                            </button>
                            <button class="btn btn-link" title="Comments">üí¨</button>
                        </div>
                    </div>

                    <!-- Article Content -->
                    <div class="o_knowledge_article_content">
                        <!-- Content will be rendered via innerHTML in JavaScript -->
                        <!-- Using t-ref to get reference to the element -->
                        <div class="o_knowledge_article_body" t-ref="content">
                            <!-- Content is rendered via renderContent() method using innerHTML -->
                        </div>
                    </div>
                </t>
                <t t-else="">
                    <div class="o_knowledge_empty_state">
                        <div class="o_knowledge_empty_state_icon">üìö</div>
                        <div class="o_knowledge_empty_state_title">Welcome to Knowledge Base</div>
                        <div class="o_knowledge_empty_state_text">
                            Select an article from the sidebar to view its content,
                            or create a new article to get started.
                        </div>
                        <button 
                            class="btn btn-primary o_knowledge_create_button"
                            t-on-click="() => this.onCreateArticle()">
                            New Article
                        </button>
                    </div>
                </t>
            </div>
        </div>

        <!-- Share Link Dialog -->
        <t t-if="state.showShareDialog">
            <div class="o_share_dialog_overlay" t-on-click="() => this.closeShareDialog()">
                <div class="o_share_dialog" t-on-click.stop="">
                    <div class="o_share_dialog_header">
                        <h3>Share Article</h3>
                        <button class="btn btn-link o_share_dialog_close" t-on-click="() => this.closeShareDialog()">
                            ‚úï
                        </button>
                    </div>
                    <div class="o_share_dialog_body">
                        <p>Share this article with others using the link below:</p>
                        <div class="o_share_link_container">
                            <input 
                                type="text" 
                                class="form-control o_share_link_input" 
                                t-att-value="state.shareLink"
                                readonly="readonly"
                            />
                            <button 
                                class="btn btn-primary o_share_copy_btn" 
                                t-on-click="() => this.copyShareLink()">
                                üìã Copy Link
                            </button>
                        </div>
                        <div class="o_share_dialog_footer">
                            <small class="text-muted">
                                Anyone with this link can view the article without logging in.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </t>
</templates>

