<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="knowledge_onthisday_oca.KnowledgeDocumentView" owl="1">
        <div class="o_knowledge_document_view" t-att-class="{'o_sidebar_mobile_open': state.sidebarOpenMobile}">
            <!-- Left Sidebar -->
            <div class="o_knowledge_sidebar">
                <!-- Search Bar -->
                <div class="o_knowledge_search">
                    <input
                        type="text"
                        class="o_knowledge_search_input"
                        placeholder="Search an article..."
                        t-on-input="(ev) => this.onSearchChange(ev.target.value)"
                    />
                    <!-- Active Tag Filter -->
                    <t t-if="state.selectedTagId">
                        <div class="o_knowledge_tag_filter">
                            <t t-set="selectedTag" t-value="state.availableTags.find(t => t.id === state.selectedTagId)"/>
                            <t t-if="selectedTag">
                                <span class="o_knowledge_tag_filter_label">Filtered by:</span>
                                <span class="o_knowledge_tag o_knowledge_tag_active"
                                      t-att-style="selectedTag.color !== false and selectedTag.color !== null and selectedTag.color !== undefined ? `background-color: var(--tag-color-${selectedTag.color}, var(--knowledge-primary)); color: var(--knowledge-text-on-primary); border-color: var(--tag-color-${selectedTag.color}, var(--knowledge-primary));` : ''"
                                      t-att-data-color-index="selectedTag.color">
                                    <span t-esc="selectedTag.name"/>
                                    <span class="o_knowledge_tag_close" t-on-click.stop="() => this.clearTagFilter()" title="Clear filter">√ó</span>
                                </span>
                            </t>
                        </div>
                    </t>
                </div>
                
                <!-- Tags Section -->
                <t t-if="state.availableTags and state.availableTags.length > 0">
                    <div class="o_knowledge_tags_section">
                        <div class="o_knowledge_tags_header">
                            <span class="o_knowledge_tags_title">Tags</span>
                            <t t-if="state.selectedTagId">
                                <button class="o_knowledge_tags_clear" t-on-click="() => this.clearTagFilter()" title="Clear tag filter">
                                    Clear
                                </button>
                            </t>
                        </div>
                        <div class="o_knowledge_tags_list">
                            <t t-foreach="state.availableTags" t-as="tag" t-key="tag.id">
                                <span class="o_knowledge_tag o_knowledge_tag_clickable"
                                      t-att-class="{'o_knowledge_tag_active': state.selectedTagId === tag.id}"
                                      t-on-click="() => this.onTagClick(tag.id)"
                                      t-att-style="tag.color !== false and tag.color !== null and tag.color !== undefined ? `background-color: var(--tag-color-${tag.color}-light, var(--knowledge-primary-bg-fallback)); color: var(--tag-color-${tag.color}, var(--knowledge-primary)); border-color: var(--tag-color-${tag.color}-border, var(--knowledge-primary-border-fallback));` : ''"
                                      t-att-data-color-index="tag.color"
                                      t-att-title="`Filter articles by ${tag.name}`">
                                    <span t-esc="tag.name"/>
                                </span>
                            </t>
                        </div>
                    </div>
                </t>

                <!-- Sections -->
                <div class="o_knowledge_sections">
                    <!-- Favorites -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('favorites')"
                        >
                            <span class="o_knowledge_section_title">Favorites</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'favorites'">
                            <t t-if="state.articles and state.articles.length > 0">
                                <!-- Display favorite articles as flat list (no category grouping) -->
                                <t t-foreach="state.articles" t-as="article" t-key="article.id">
                                    <div class="o_knowledge_article_item o_knowledge_article_parent"
                                         t-att-class="{'o_active': state.selectedArticleId === article.id, 'o_expanded': this.isExpanded(article.id)}">
                                        <div class="o_knowledge_article_item_header"
                                             t-on-click="(ev) => this.onArticleClick(article.id, ev)">
                                            <t t-if="article.children and article.children.length > 0">
                                                <span class="o_knowledge_expand_icon"
                                                      t-att-class="this.isExpanded(article.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"
                                                      t-on-click.stop="() => this.toggleExpand(article.id)">
                                                </span>
                                            </t>
                                            <t t-else="">
                                                <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                            </t>
                                            <span class="o_knowledge_article_icon" t-esc="article.article_icon || article.category_icon || 'üìù'"/>
                                            <div class="o_knowledge_article_info">
                                                <span class="o_knowledge_article_name" t-esc="article.name"/>
                                            </div>
                                        </div>
                                        <t t-if="article.children and article.children.length > 0 and this.isExpanded(article.id)">
                                            <div class="o_knowledge_article_children">
                                                <t t-foreach="article.children" t-as="child" t-key="child.id">
                                                    <div class="o_knowledge_article_item o_knowledge_article_child"
                                                         t-on-click.stop="() => this.onArticleClick(child.id)"
                                                         t-att-class="{'o_active': state.selectedArticleId === child.id}">
                                                        <div class="o_knowledge_article_item_header">
                                                            <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                            <span class="o_knowledge_article_icon" t-esc="child.article_icon || child.category_icon || 'üìù'"/>
                                                            <div class="o_knowledge_article_info">
                                                                <span class="o_knowledge_article_name" t-esc="child.name"/>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="o_knowledge_empty">
                                    <div class="o_knowledge_empty_icon">‚≠ê</div>
                                    <div class="o_knowledge_empty_text">No favorite articles yet</div>
                                    <div class="o_knowledge_empty_subtext">Mark articles as favorites to access them quickly</div>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Workspace -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('workspace')"
                        >
                            <span class="o_knowledge_section_title">Workspace</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'workspace'">
                            <t t-if="!state.loading">
                                <t t-if="state.articles and state.articles.length > 0">
                                    <!-- Show all categories, including those with articles -->
                                    <t t-foreach="state.articles" t-as="category" t-key="category.id">
                                        <!-- Category Header -->
                                        <div class="o_knowledge_category_group">
                                            <div class="o_knowledge_category_header"
                                                 t-att-class="{'o_expanded': this.isCategoryExpanded(category.id)}"
                                                 t-on-click="() => this.toggleExpandCategory(category.id)">
                                                <span class="o_knowledge_expand_icon"
                                                      t-att-class="this.isCategoryExpanded(category.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'">
                                                </span>
                                                <span class="o_knowledge_category_icon" t-esc="category.icon || 'üìù'"/>
                                                <span class="o_knowledge_category_name" t-esc="category.name || 'Uncategorized'"/>
                                                <span class="o_knowledge_category_count" t-esc="`(${category.articles ? category.articles.length : 0})`"/>
                                            </div>
                                            
                                            <!-- Category Articles -->
                                            <t t-if="this.isCategoryExpanded(category.id)">
                                                <div class="o_knowledge_category_articles">
                                                    <!-- Debug: Show category info -->
                                                    <t t-if="category.id === 'uncategorized'">
                                                        <!-- Debug info for Uncategorized -->
                                                    </t>
                                                    <t t-if="category.articles and category.articles.length > 0">
                                                        <t t-foreach="category.articles" t-as="article" t-key="article.id">
                                                            <div class="o_knowledge_article_item o_knowledge_article_parent"
                                                                 t-att-class="{'o_active': state.selectedArticleId === article.id, 'o_expanded': this.isExpanded(article.id)}">
                                                                <div class="o_knowledge_article_item_header"
                                                                     t-on-click="(ev) => this.onArticleClick(article.id, ev)">
                                                                    <t t-if="article.children and article.children.length > 0">
                                                                        <span class="o_knowledge_expand_icon"
                                                                              t-att-class="this.isExpanded(article.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"
                                                                              t-on-click.stop="() => this.toggleExpand(article.id)">
                                                                        </span>
                                                                    </t>
                                                                    <t t-else="">
                                                                        <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                    </t>
                                                                    <span class="o_knowledge_article_icon" t-esc="article.article_icon || article.category_icon || 'üìù'"/>
                                                                    <div class="o_knowledge_article_info">
                                                                        <span class="o_knowledge_article_name" t-esc="article.name"/>
                                                                    </div>
                                                                </div>
                                                                <t t-if="article.children and article.children.length > 0 and this.isExpanded(article.id)">
                                                                    <div class="o_knowledge_article_children">
                                                                        <t t-foreach="article.children" t-as="child" t-key="child.id">
                                                                            <div class="o_knowledge_article_item o_knowledge_article_child"
                                                                                 t-on-click.stop="() => this.onArticleClick(child.id)"
                                                                                 t-att-class="{'o_active': state.selectedArticleId === child.id}">
                                                                                <div class="o_knowledge_article_item_header">
                                                                                    <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                                    <span class="o_knowledge_article_icon" t-esc="child.article_icon || child.category_icon || 'üìù'"/>
                                                                                    <div class="o_knowledge_article_info">
                                                                                        <span class="o_knowledge_article_name" t-esc="child.name"/>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </t>
                                                                    </div>
                                                                </t>
                                                            </div>
                                                        </t>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="o_knowledge_empty_category">
                                                            <span>No articles in this category yet</span>
                                                        </div>
                                                    </t>
                                                </div>
                                            </t>
                                        </div>
                                    </t>
                                    <t t-if="state.hasMoreArticles">
                                        <div class="o_knowledge_load_more">
                                            <button class="btn btn-outline-secondary"
                                                    t-on-click="() => this.loadMoreArticles()"
                                                    t-att-disabled="state.loadingMoreArticles">
                                                <t t-if="state.loadingMoreArticles">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</t>
                                                <t t-else="">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</t>
                                            </button>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="o_knowledge_empty">
                                        <div class="o_knowledge_empty_icon">üìö</div>
                                        <div class="o_knowledge_empty_text">No articles yet</div>
                                        <div class="o_knowledge_empty_subtext">Create your first article to get started</div>
                                    </div>
                                </t>
                            </t>
                        </div>
                    </div>

                    <!-- Shared -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('shared')"
                        >
                            <span class="o_knowledge_section_title">Shared</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'shared'">
                            <t t-if="state.articles and state.articles.length > 0">
                                <!-- Display shared articles grouped by category -->
                                <t t-foreach="state.articles" t-as="category" t-key="category.id">
                                    <div class="o_knowledge_category_group">
                                        <div class="o_knowledge_category_header"
                                             t-att-class="{'o_expanded': this.isCategoryExpanded(category.id)}"
                                             t-on-click="() => this.toggleExpandCategory(category.id)">
                                            <span class="o_knowledge_expand_icon"
                                                  t-att-class="this.isCategoryExpanded(category.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'">
                                            </span>
                                            <span class="o_knowledge_category_icon" t-esc="category.icon || 'üìù'"/>
                                            <span class="o_knowledge_category_name" t-esc="category.name || 'Uncategorized'"/>
                                            <span class="o_knowledge_category_count" t-esc="`(${category.articles ? category.articles.length : 0})`"/>
                                        </div>
                                        <t t-if="this.isCategoryExpanded(category.id)">
                                            <div class="o_knowledge_category_articles">
                                                <t t-if="category.articles and category.articles.length > 0">
                                                    <t t-foreach="category.articles" t-as="article" t-key="article.id">
                                                        <div class="o_knowledge_article_item o_knowledge_article_parent"
                                                             t-att-class="{'o_active': state.selectedArticleId === article.id, 'o_expanded': this.isExpanded(article.id)}">
                                                            <div class="o_knowledge_article_item_header"
                                                                 t-on-click="(ev) => this.onArticleClick(article.id, ev)">
                                                                <t t-if="article.children and article.children.length > 0">
                                                                    <span class="o_knowledge_expand_icon"
                                                                          t-att-class="this.isExpanded(article.id) ? 'fa fa-chevron-down' : 'fa fa-chevron-right'"
                                                                          t-on-click.stop="() => this.toggleExpand(article.id)">
                                                                    </span>
                                                                </t>
                                                                <t t-else="">
                                                                    <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                </t>
                                                                <span class="o_knowledge_article_icon" t-esc="article.article_icon || article.category_icon || 'üìù'"/>
                                                                <div class="o_knowledge_article_info">
                                                                    <span class="o_knowledge_article_name" t-esc="article.name"/>
                                                                </div>
                                                            </div>
                                                            <t t-if="article.children and article.children.length > 0 and this.isExpanded(article.id)">
                                                                <div class="o_knowledge_article_children">
                                                                    <t t-foreach="article.children" t-as="child" t-key="child.id">
                                                                        <div class="o_knowledge_article_item o_knowledge_article_child"
                                                                             t-on-click.stop="() => this.onArticleClick(child.id)"
                                                                             t-att-class="{'o_active': state.selectedArticleId === child.id}">
                                                                            <div class="o_knowledge_article_item_header">
                                                                                <span class="o_knowledge_expand_icon o_knowledge_expand_icon_empty"></span>
                                                                                <span class="o_knowledge_article_icon" t-esc="child.article_icon || child.category_icon || 'üìù'"/>
                                                                                <div class="o_knowledge_article_info">
                                                                                    <span class="o_knowledge_article_name" t-esc="child.name"/>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </t>
                                                                </div>
                                                            </t>
                                                        </div>
                                                    </t>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="o_knowledge_empty">
                                    <div class="o_knowledge_empty_icon">üîó</div>
                                    <div class="o_knowledge_empty_text">No shared articles yet</div>
                                    <div class="o_knowledge_empty_subtext">Articles shared with you will appear here</div>
                                </div>
                            </t>
                        </div>
                    </div>

                    <!-- Private -->
                    <div class="o_knowledge_section">
                        <div 
                            class="o_knowledge_section_header"
                            t-on-click="() => this.setActiveSection('private')"
                        >
                            <span class="o_knowledge_section_title">Private</span>
                        </div>
                        <div class="o_knowledge_section_content" t-if="state.activeSection === 'private'">
                            <div class="o_knowledge_empty">No private articles yet</div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Actions -->
                <div class="o_knowledge_bottom_actions">
                    <div class="o_knowledge_action_item">
                        <span class="o_knowledge_action_icon">üìÑ</span>
                        <span class="o_knowledge_action_label">Browse Templates</span>
                    </div>
                    <div class="o_knowledge_action_item" t-on-click="() => this.onOpenTrash()">
                        <span class="o_knowledge_action_icon">üóëÔ∏è</span>
                        <span class="o_knowledge_action_label">Open the Trash</span>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="o_knowledge_main_content">
                <!-- Mobile menu toggle -->
                <t t-if="!state.sidebarOpenMobile">
                    <button class="o_knowledge_menu_toggle" t-on-click="() => this.toggleSidebarMobile()">
                        ‚ò∞ Menu
                    </button>
                </t>
                <t t-if="state.loading">
                    <div class="o_knowledge_loading">Loading article...</div>
                </t>
                <t t-elif="state.searchQuery">
                    <t t-set="searchArticles" t-value="this.getSearchResults()"/>
                    <div class="o_knowledge_search_results">
                        <div class="o_knowledge_search_header">
                            <div class="o_knowledge_search_title">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
                            <div class="o_knowledge_search_subtitle">
                                ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤: "<t t-esc="state.searchQuery"/>"
                            </div>
                            <div class="o_knowledge_search_bar">
                                <div class="o_knowledge_search_filters">
                                    <label>
                                        Sort:
                                        <select t-model="state.searchSort" t-on-change="() => this.fetchSearchResults(1)">
                                            <option value="recent">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
                                            <option value="name">‡∏ä‡∏∑‡πà‡∏≠</option>
                                            <option value="views">‡∏¢‡∏≠‡∏î‡∏ß‡∏¥‡∏ß</option>
                                        </select>
                                    </label>
                                    <label>
                                        Category:
                                        <select t-on-change="(ev) => this.onCategoryChange(ev.target.value)">
                                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                            <t t-foreach="state.filterOptions.categories" t-as="cat" t-key="cat.id">
                                                <option t-att-value="cat.id" t-att-selected="state.searchFilters.category_id === cat.id"><t t-esc="cat.name"/></option>
                                            </t>
                                        </select>
                                    </label>
                                    <label>
                                        Responsible:
                                        <select t-on-change="(ev) => this.onResponsibleChange(ev.target.value)">
                                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                            <t t-foreach="state.filterOptions.users" t-as="user" t-key="user.id">
                                                <option t-att-value="user.id" t-att-selected="state.searchFilters.responsible_id === user.id"><t t-esc="user.name"/></option>
                                            </t>
                                        </select>
                                    </label>
                                </div>
                                <div class="o_knowledge_search_meta">
                                    <span t-if="state.searchLoading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</span>
                                    <span t-elif="state.searchTotal">‡∏û‡∏ö <t t-esc="state.searchTotal"/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                                </div>
                            </div>
                        </div>
                        <t t-if="state.searchLoading">
                            <div class="o_knowledge_search_skeletons">
                                <div class="o_knowledge_search_skeleton" t-foreach="[1,2,3]" t-as="i" t-key="i"></div>
                            </div>
                        </t>
                        <t t-if="searchArticles.length &amp;&amp; !state.searchLoading">
                            <div class="o_knowledge_search_cards">
                                <t t-foreach="searchArticles" t-as="article" t-key="article.id">
                                    <div class="o_knowledge_search_card" t-on-click="() => this.onArticleClick(article.id)">
                                        <div class="o_knowledge_search_card_header">
                                            <div class="o_knowledge_search_card_title" t-esc="article.name"/>
                                            <t t-if="article.responsible_name">
                                                <span class="o_knowledge_author_badge">
                                                    <t t-if="article.responsible_avatar">
                                                        <img t-att-src="'data:image/png;base64,' + article.responsible_avatar" class="o_knowledge_author_avatar_img"/>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="o_knowledge_author_avatar">üë§</span>
                                                    </t>
                                                    <span t-esc="article.responsible_name"/>
                                                </span>
                                            </t>
                                        </div>
                                        <t t-if="article.search_meta">
                                            <div class="o_knowledge_search_card_meta" t-esc="article.search_meta"/>
                                        </t>
                                        <t t-if="article.search_snippet">
                                            <div class="o_knowledge_search_card_snippet" t-raw="article.search_snippet"/>
                                        </t>
                                    </div>
                                </t>
                            </div>
                            <div class="o_knowledge_search_pager" t-if="state.searchTotal &gt; state.searchPageSize">
                                <button class="btn btn-secondary" t-att-disabled="state.searchPage &lt;= 1"
                                        t-on-click="() => this.fetchSearchResults(state.searchPage - 1)">‚Äπ Prev</button>
                                <span>Page <t t-esc="state.searchPage"/> / <t t-esc="Math.ceil(state.searchTotal / state.searchPageSize)"/></span>
                                <button class="btn btn-secondary" t-att-disabled="state.searchPage * state.searchPageSize &gt;= state.searchTotal"
                                        t-on-click="() => this.fetchSearchResults(state.searchPage + 1)">Next ‚Ä∫</button>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="o_knowledge_empty_list_placeholder">
                                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                <button class="btn btn-primary btn-sm" t-on-click="() => this.onCreateArticle()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                            </div>
                        </t>
                    </div>
                </t>
                <t t-elif="state.currentArticle">
                    <!-- Article Header -->
                    <div class="o_knowledge_article_header">
                        <div class="o_knowledge_article_header_left">
                            <h1 class="o_knowledge_article_title">
                                <span class="o_knowledge_article_icon" t-esc="state.currentArticle.article_icon || state.currentArticle.category_icon || 'üìù'"/>
                                <span t-esc="state.currentArticle.name"/>
                            </h1>
                            <!-- Tags -->
                            <t t-if="state.currentArticle.tag_ids and state.currentArticle.tag_ids.length > 0">
                                <div class="o_knowledge_article_tags">
                                    <t t-foreach="state.currentArticle.tag_ids" t-as="tag" t-key="tag.id">
                                        <span class="o_knowledge_tag o_knowledge_tag_clickable" 
                                              t-att-class="{'o_knowledge_tag_active': state.selectedTagId === tag.id}"
                                              t-on-click.stop="() => this.onTagClick(tag.id)"
                                              t-att-style="tag.color !== false and tag.color !== null and tag.color !== undefined ? `background-color: var(--tag-color-${tag.color}-light, var(--knowledge-primary-bg-fallback)); color: var(--tag-color-${tag.color}, var(--knowledge-primary)); border-color: var(--tag-color-${tag.color}-border, var(--knowledge-primary-border-fallback));` : ''"
                                              t-att-data-color-index="tag.color"
                                              t-att-title="`Click to filter by ${tag.name}`">
                                            <span t-esc="tag.name"/>
                                        </span>
                                    </t>
                                </div>
                            </t>
                        </div>
                        <div class="o_knowledge_article_header_right">
                            <button class="btn btn-primary" t-on-click="() => this.onEditArticle()">
                                <span>‚úèÔ∏è</span> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                            </button>
                            <button class="btn btn-secondary" t-on-click="() => this.onCreateArticle()">
                                <span>‚ûï</span> New
                            </button>
                            <button 
                                class="btn btn-link" 
                                t-att-class="{'o_favorited': this.isFavorited(state.currentArticle)}"
                                t-on-click="() => this.toggleFavorite(state.currentArticle.id)"
                                title="Favorite">
                                <i t-att-class="this.isFavorited(state.currentArticle) ? 'fa fa-star o_knowledge_header_icon' : 'fa fa-star-o o_knowledge_header_icon'"/>
                            </button>
                            <button 
                                class="btn btn-link" 
                                t-att-class="{'o_shared': this.isShared(state.currentArticle)}"
                                t-on-click="() => this.toggleShare(state.currentArticle.id)"
                                t-att-title="this.isShared(state.currentArticle) ? `Shared with ${this.getSharedCount(state.currentArticle)} user(s)` : 'Share'">
                                <i class="fa fa-share-alt o_knowledge_header_icon"/>
                                <span class="o_knowledge_action_text">Share</span>
                                <span t-if="this.isShared(state.currentArticle) and this.getSharedCount(state.currentArticle) > 0" 
                                      class="o_share_count" 
                                      t-esc="`(${this.getSharedCount(state.currentArticle)})`"/>
                            </button>
                            <button
                                class="btn btn-link o_knowledge_revision_button"
                                t-on-click="() => this.onOpenRevisionHistory()"
                                title="Revision history">
                                <i class="fa fa-history o_knowledge_header_icon"/>
                            </button>
                            <button 
                                class="btn btn-link" 
                                t-att-class="{'o_active': state.showCommentPanel}"
                                t-on-click="() => this.toggleCommentPanel()"
                                title="Comments">
                                <i class="fa fa-comment-o o_knowledge_header_icon"/>
                                <t t-if="state.currentArticle and state.currentArticle.comment_count">
                                    <span class="badge badge-secondary" t-esc="state.currentArticle.comment_count"/>
                                </t>
                            </button>
                        </div>
                    </div>

                    <!-- Article Content -->
                    <div class="o_knowledge_article_content" t-att-class="{'o_knowledge_with_comments': state.showCommentPanel}">
                        <!-- Content will be rendered via innerHTML in JavaScript -->
                        <!-- Using t-ref to get reference to the element -->
                        <div class="o_knowledge_article_body" t-ref="content">
                            <!-- Content is rendered via renderContent() method using innerHTML -->
                        </div>
                        <!-- Floating Comment Button (shown when text is selected) -->
                        <t t-if="state.showCommentButton">
                            <div 
                                class="o_knowledge_comment_button_floating"
                                t-attf-style="top: #{state.commentButtonPosition.top}px; left: #{state.commentButtonPosition.left}px;">
                                <button 
                                    class="btn btn-primary btn-sm"
                                    t-on-click="() => this.onCreateCommentFromSelection()">
                                    <i class="fa fa-comment"/> ‡πÄ‡∏û‡∏¥‡πà‡∏° Comment
                                </button>
                            </div>
                        </t>
                    </div>

                    <!-- Comment Panel - Temporarily disabled to allow module to load -->
                    <!-- Will be re-enabled after fixing CommentOverlay import issues -->
                    <!--
                    <t t-if="state.currentArticle and state.showCommentPanel">
                        <div class="o_knowledge_comment_panel">
                            <CommentOverlay 
                                t-props="{
                                    articleId: state.currentArticle.id,
                                    contentElement: contentRef.el,
                                    selectionData: state.currentTextSelection,
                                    triggerCreation: state.triggerCommentCreation,
                                    onCreateCommentFromSelection: () => this.onCreateCommentFromSelection(),
                                }"/>
                        </div>
                    </t>
                    -->
                </t>
                <t t-else="">
                    <div class="o_knowledge_empty_state">
                        <t t-if="state.activeSection === 'trash'">
                            <div class="o_knowledge_empty_state_header">
                                <div>
                                    <div class="o_knowledge_empty_state_title">Trash</div>
                                    <div class="o_knowledge_empty_state_text">
                                        ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏°‡∏≤ Trash (Archive) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô/‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£‡πÑ‡∏î‡πâ
                                    </div>
                                </div>
                            </div>
                            <div class="o_knowledge_empty_cards">
                                <div class="o_knowledge_empty_card o_knowledge_empty_card_full">
                                    <t t-set="trashArticles" t-value="this.getTrashArticles()"/>
                                    <t t-if="trashArticles.length">
                                        <ul class="o_knowledge_empty_list">
                                            <t t-foreach="trashArticles" t-as="article" t-key="article.id">
                                                <li t-on-click="() => this.onArticleClick(article.id)">
                                                   <div class="o_knowledge_empty_list_title" t-esc="article.name"/>
                                                   <div class="o_knowledge_empty_list_meta">
                                                       <t t-if="article.category_name">
                                                           <span t-esc="article.category_name"/>
                                                       </t>
                                                       <t t-if="article.write_date">
                                                           <span t-esc="article.write_date"/>
                                                       </t>
                                                   <t t-if="article.responsible_name">
                                                        <span class="o_knowledge_author_badge">
                                                            <t t-if="article.responsible_avatar">
                                                                <img t-att-src="'data:image/png;base64,' + article.responsible_avatar" class="o_knowledge_author_avatar_img"/>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="o_knowledge_author_avatar">üë§</span>
                                                            </t>
                                                            <span t-esc="article.responsible_name"/>
                                                        </span>
                                                   </t>
                                                  </div>
                                              </li>
                                          </t>
                                      </ul>
                                    </t>
                                    <t t-else="">
                                        <div class="o_knowledge_empty_list_placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô Trash</div>
                                    </t>
                                </div>
                            </div>
                        </t>
                        <t t-else="">
                            <div class="o_knowledge_empty_state_header">
                                <div>
                                    <div class="o_knowledge_empty_state_title">Welcome to Knowledge Base</div>
                                    <div class="o_knowledge_empty_state_text">
                                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                                    </div>
                                </div>
                                <div>
                                    <button 
                                        class="btn btn-primary o_knowledge_create_button"
                                        t-on-click="() => this.onCreateArticle()">
                                        ‚ûï New Article
                                    </button>
                                </div>
                            </div>
                            <div class="o_knowledge_empty_cards">
                                <div class="o_knowledge_empty_card">
                                    <div class="o_knowledge_empty_card_header">
                                        <span>‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏ö‡πà‡∏≠‡∏¢</span>
                                    </div>
                                    <t t-set="popularArticles" t-value="this.getPopularArticles(5)"/>
                                    <t t-if="popularArticles.length">
                                        <ul class="o_knowledge_empty_list">
                                            <t t-foreach="popularArticles" t-as="article" t-key="article.id">
                                                <li t-on-click="() => this.onArticleClick(article.id)">
                                                <div class="o_knowledge_empty_list_title" t-esc="article.name"/>
                                               <div class="o_knowledge_empty_list_meta">
                                                   <t t-if="article.category_name">
                                                       <span t-esc="article.category_name"/>
                                                   </t>
                                                   <t t-if="article.responsible_name">
                                                        <span class="o_knowledge_author_badge">
                                                            <t t-if="article.responsible_avatar">
                                                                <img t-att-src="'data:image/png;base64,' + article.responsible_avatar" class="o_knowledge_author_avatar_img"/>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="o_knowledge_author_avatar">üë§</span>
                                                            </t>
                                                            <span t-esc="article.responsible_name"/>
                                                        </span>
                                                    </t>
                                               </div>
                                           </li>
                                       </t>
                                    </ul>
                                    </t>
                                    <t t-else="">
                                        <div class="o_knowledge_empty_list_placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                                    </t>
                                </div>
                                <div class="o_knowledge_empty_card">
                                    <div class="o_knowledge_empty_card_header">
                                        <span>‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
                                    </div>
                                    <t t-set="recentArticles" t-value="this.getRecentArticles(5)"/>
                                    <t t-if="recentArticles.length">
                                        <ul class="o_knowledge_empty_list">
                                            <t t-foreach="recentArticles" t-as="article" t-key="article.id">
                                                <li t-on-click="() => this.onArticleClick(article.id)">
                                                <div class="o_knowledge_empty_list_title" t-esc="article.name"/>
                                                <div class="o_knowledge_empty_list_meta">
                                                    <t t-if="article.category_name">
                                                        <span t-esc="article.category_name"/>
                                                    </t>
                                                    <t t-if="article.write_date">
                                                        <span t-esc="article.write_date"/>
                                                    </t>
                                                    <t t-if="article.responsible_name">
                                                        <span class="o_knowledge_author_badge">
                                                            <t t-if="article.responsible_avatar">
                                                                <img t-att-src="'data:image/png;base64,' + article.responsible_avatar" class="o_knowledge_author_avatar_img"/>
                                                            </t>
                                                            <t t-else="">
                                                                <span class="o_knowledge_author_avatar">üë§</span>
                                                            </t>
                                                            <span t-esc="article.responsible_name"/>
                                                        </span>
                                                    </t>
                                                </div>
                                            </li>
                                        </t>
                                    </ul>
                                    </t>
                                    <t t-else="">
                                        <div class="o_knowledge_empty_list_placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                                    </t>
                                </div>
                                <div class="o_knowledge_empty_card">
                                    <div class="o_knowledge_empty_card_header">
                                        <span>‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
                                    </div>
                                    <t t-set="newestArticles" t-value="this.getNewestArticles(5)"/>
                                    <t t-if="newestArticles.length">
                                        <ul class="o_knowledge_empty_list">
                                            <t t-foreach="newestArticles" t-as="article" t-key="article.id">
                                                <li t-on-click="() => this.onArticleClick(article.id)">
                                                    <div class="o_knowledge_empty_list_title" t-esc="article.name"/>
                                                    <div class="o_knowledge_empty_list_meta">
                                                        <t t-if="article.category_name">
                                                            <span t-esc="article.category_name"/>
                                                        </t>
                                                        <t t-if="article.write_date">
                                                            <span t-esc="article.write_date"/>
                                                        </t>
                                                        <t t-if="article.responsible_name">
                                                            <span class="o_knowledge_author_badge">
                                                                <t t-if="article.responsible_avatar">
                                                                    <img t-att-src="'data:image/png;base64,' + article.responsible_avatar" class="o_knowledge_author_avatar_img"/>
                                                                </t>
                                                                <t t-else="">
                                                                    <span class="o_knowledge_author_avatar">üë§</span>
                                                                </t>
                                                                <span t-esc="article.responsible_name"/>
                                                            </span>
                                                        </t>
                                                    </div>
                                                </li>
                                            </t>
                                        </ul>
                                    </t>
                                    <t t-else="">
                                        <div class="o_knowledge_empty_list_placeholder">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                                    </t>
                                </div>
                            </div>
                        </t>
                    </div>
                </t>
            </div>
            
            <!-- Comment Overlay - Always render when article is loaded to show highlights -->
            <!-- Render CommentOverlay separately from panel to ensure it's always mounted -->
            <t t-if="state.currentArticle">
                <!-- CommentOverlay component (always mounted for highlights) -->
                <CommentOverlay 
                    t-key="'comment-overlay-' + (state.currentArticle.id || 'no-article')"
                    t-props="{
                        articleId: state.currentArticle.id,
                        contentElement: contentRef.el,
                        selectionData: state.currentTextSelection,
                        triggerCreation: state.triggerCommentCreation,
                        showCommentPanel: state.showCommentPanel,
                        onCreateCommentFromSelection: () => this.onCreateCommentFromSelection(),
                        onClose: () => this.closeCommentPanel(),
                        onHighlightClick: (commentId) => this.onHighlightClick(commentId)
                    }"/>
            </t>
            
            <!-- Overlay for mobile -->
            <t t-if="state.sidebarOpenMobile">
                <div class="o_knowledge_sidebar_overlay" t-on-click="() => this.closeSidebarMobile()"></div>
            </t>
        </div>

        <!-- Share Link Dialog -->
        <t t-if="state.showShareDialog">
            <div class="o_share_dialog_overlay" t-on-click="() => this.closeShareDialog()">
                <div class="o_share_dialog" t-on-click.stop="">
                    <div class="o_share_dialog_header">
                        <h3>Who gets access?</h3>
                        <button class="btn btn-link o_share_dialog_close" t-on-click="() => this.closeShareDialog()">
                            ‚úï
                        </button>
                    </div>
                    <div class="o_share_dialog_body">
                        <div class="o_share_public_row">
                            <div class="o_share_public_text">
                                <div class="o_share_public_title">Article Published</div>
                                <div class="o_share_public_subtitle">Anyone can view</div>
                            </div>
                            <label class="o_share_switch">
                                <input type="checkbox"
                                       t-att-checked="state.sharePublic"
                                       t-att-disabled="!state.shareCanManage"
                                       t-on-change="() => this.toggleSharePublic()"/>
                                <span class="o_share_slider"/>
                            </label>
                        </div>

                        <t t-if="state.sharePublic">
                            <div class="o_share_link_container">
                                <input
                                    type="text"
                                    class="form-control o_share_link_input"
                                    t-att-value="state.shareLink"
                                    readonly="readonly"
                                />
                                <button
                                    class="btn btn-primary o_share_copy_btn"
                                    t-on-click="() => this.copyShareLink()"
                                    t-att-disabled="!state.shareLink">
                                    üìã Copy Link
                                </button>
                            </div>
                        </t>

                        <div class="o_share_default_row">
                            <div class="o_share_default_text">
                                <div class="o_share_default_title">Default Access Rights</div>
                                <div class="o_share_default_subtitle">
                                    Based on <t t-esc="state.shareCategoryName || 'Uncategorized'"/>
                                </div>
                            </div>
                            <select class="form-control o_share_default_select"
                                    t-att-value="state.shareDefaultPermission"
                                    t-att-disabled="!state.shareCanManage"
                                    t-on-change="(ev) => this.updateDefaultSharePermission(ev)">
                                <option value="read">Can read</option>
                                <option value="edit">Can edit</option>
                            </select>
                        </div>

                        <div class="o_share_invite_row">
                            <div class="o_share_invite_input_wrapper">
                                <input type="text"
                                       class="form-control o_share_invite_input"
                                       placeholder="Add people or email addresses..."
                                       t-att-value="state.shareInviteQuery"
                                       t-att-disabled="!state.shareCanManage"
                                       t-on-input="(ev) => this.onShareInviteInput(ev)"
                                       t-on-focus="() => this.onShareInviteFocus()"
                                       t-on-blur="() => this.onShareInviteBlur()"/>
                                <t t-if="state.shareInviteSuggestions &amp;&amp; state.shareInviteSuggestions.length">
                                    <div class="o_share_invite_suggestions">
                                        <t t-foreach="state.shareInviteSuggestions" t-as="suggestion" t-key="suggestion.id">
                                            <button type="button"
                                                    class="o_share_invite_suggestion"
                                                    t-on-mousedown.prevent="() => this.selectShareInviteSuggestion(suggestion)">
                                                <span class="o_share_invite_suggestion_name" t-esc="suggestion.name"/>
                                                <span class="o_share_invite_suggestion_email" t-esc="suggestion.email"/>
                                            </button>
                                        </t>
                                    </div>
                                </t>
                            </div>
                            <select class="form-control o_share_invite_select"
                                    t-att-value="state.shareInvitePermission"
                                    t-att-disabled="!state.shareCanManage"
                                    t-on-change="(ev) => this.onShareInvitePermissionChange(ev)">
                                <option value="read">Can read</option>
                                <option value="edit">Can edit</option>
                            </select>
                            <button class="btn btn-primary o_share_invite_btn"
                                    t-on-click="() => this.inviteShareMember()"
                                    t-att-disabled="!state.shareCanManage or state.shareInviteLoading">
                                Invite
                            </button>
                        </div>

                        <div class="o_share_member_list">
                            <t t-if="state.shareMembers and state.shareMembers.length">
                                <t t-foreach="state.shareMembers" t-as="member" t-key="member.member_id || ('owner-' + member.user_id)">
                                    <div class="o_share_member_row">
                                        <div class="o_share_member_info">
                                            <div class="o_share_member_name" t-esc="member.name"/>
                                            <div class="o_share_member_email" t-esc="member.email"/>
                                        </div>
                                        <div class="o_share_member_actions">
                                            <t t-if="member.is_owner">
                                                <span class="o_share_owner_badge">Owner</span>
                                            </t>
                                            <t t-else="">
                                                <select class="form-control o_share_member_select"
                                                        t-att-value="member.permission"
                                                        t-att-disabled="!state.shareCanManage"
                                                        t-on-change="(ev) => this.updateShareMemberPermission(member.member_id, ev.target.value)">
                                                    <option value="read">Can read</option>
                                                    <option value="edit">Can edit</option>
                                                </select>
                                                <button class="btn btn-link o_share_member_remove"
                                                        t-on-click="() => this.removeShareMember(member.member_id)"
                                                        t-att-disabled="!state.shareCanManage">
                                                    ‚úï
                                                </button>
                                            </t>
                                        </div>
                                    </div>
                                </t>
                            </t>
                            <t t-else="">
                                <div class="o_share_empty_text">No shared users yet</div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </t>
</templates>
